{% extends './base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="container-fluid mt-5">
  <!-- CSRF via WTForms -->
  <form id="csrf-form" style="display:none;">
    {{ form.hidden_tag() }}
  </form>
  <div class="row">
    <!-- Groups Listing -->
    <div class="col-md-8">
      <h2>Your Dashboard</h2>
      <div id="groups-container">
        <div class="row">
          {% for group in groups %}
          <div class="col-lg-6 col-xl-4 mb-4 group-card" id="group-{{ group.id }}">
            <div class="card h-100">
              {% if group.picture_filename %}
              <img src="{{ url_for('static', filename='uploads/' ~ group.picture_filename) }}" class="card-img-top">
              {% endif %}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ group.name }}</h5>
                <p class="card-text flex-grow-1">Members: {{ group.member_count }}</p>
                <button
                  type="button"
                  class="btn btn-primary basket-btn mt-auto"
                  data-id="{{ group.id }}"
                  data-name="{{ group.name }}"
                  {% if group.id in basket_ids %}disabled{% endif %}>
                  {% if group.id in basket_ids %}Added to Cart{% else %}Add to Cart{% endif %}
                </button>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Basket Sidebar -->
    <div class="col-md-4">
      <div class="card sticky-top" style="top: 20px;">
        <div class="card-header">
          <h5 class="mb-0">Your Cart <span class="badge bg-secondary" id="basket-count">{{ basket_ids|length }}</span>/{{ config['GROUP_CHECKOUT_LIMIT'] }}</h5>
        </div>
        <ul class="list-group list-group-flush" id="basket-list" style="max-height: 70vh; overflow-y: auto;">
          {% for gid in basket_ids %}
          {% set g = groups|selectattr('id','equalto',gid)|first %}
          <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ gid }}">
            {{ g.name }}
            <button class="btn btn-sm btn-outline-danger remove-btn" data-id="{{ gid }}">Remove</button>
          </li>
          {% endfor %}
        </ul>
        <div class="card-body text-center">
          <a href="{{ url_for('main.checkout') }}" class="btn btn-success w-100" id="checkout-btn" {% if basket_ids|length == 0 %}disabled{% endif %}>Checkout</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Grab CSRF token from WTForms hidden form
    const csrfToken = document.querySelector('#csrf-form input[name="csrf_token"]').value;
    console.log('Dashboard JS loaded with CSRF token:', csrfToken);

    // Add to Cart
    document.querySelectorAll('.basket-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const groupId = btn.getAttribute('data-id');
        fetch("{{ url_for('main.add_to_basket') }}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ group_id: groupId })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            btn.disabled = true;
            btn.textContent = 'Added to Cart';
            document.getElementById('basket-count').textContent = data.basket_count;
            // Append to sidebar
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.setAttribute('data-id', groupId);
            li.innerHTML = `${btn.getAttribute('data-name')} <button class="btn btn-sm btn-outline-danger remove-btn" data-id="${groupId}">Remove</button>`;
            document.getElementById('basket-list').appendChild(li);
            attachRemove(li.querySelector('.remove-btn'));
            document.getElementById('checkout-btn').disabled = false;
          } else {
            alert(data.message);
          }
        })
        .catch(err => console.error('Error adding to cart:', err));
      });
    });

    // Remove from Cart helper
    function attachRemove(btn) {
      btn.addEventListener('click', () => {
        const groupId = btn.getAttribute('data-id');
        fetch("{{ url_for('main.remove_from_basket') }}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ group_id: groupId })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Remove list item
            const li = document.querySelector(`#basket-list li[data-id='${groupId}']`);
            if (li) li.remove();
            // Re-enable button
            const addBtn = document.querySelector(`.basket-btn[data-id='${groupId}']`);
            if (addBtn) {
              addBtn.disabled = false;
              addBtn.textContent = 'Add to Cart';
            }
            document.getElementById('basket-count').textContent = data.basket_count;
            document.getElementById('checkout-btn').disabled = (data.basket_count === 0);
          } else {
            alert(data.message);
          }
        })
        .catch(err => console.error('Error removing from cart:', err));
      });
    }

    // Attach remove to existing items
    document.querySelectorAll('.remove-btn').forEach(btn => attachRemove(btn));
  });
</script>
{% endblock %}
