{% extends './base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="container-fluid mt-5">
  <!-- CSRF via WTForms -->
  <form id="csrf-form" style="display:none;">
    {{ form.hidden_tag() }}
  </form>

  {# Prepare lists #}
  {% set purchased_ids = current_user.purchased_items | map(attribute='group_id') | list %}
  {% set basket_count = basket_ids | length %}
  {% set limit = config['GROUP_CHECKOUT_LIMIT'] %}

  <h2>Your Dashboard</h2>
  <div class="row">
    <!-- Group Cards -->
    <div class="col-md-8">
      <div class="row" id="groups-container">
        {% for group in groups %}
        <div class="col-lg-6 col-xl-4 mb-4 group-card" id="group-{{ group.id }}">
          <div class="card h-100">
            {% if group.picture_filename %}
            <img src="{{ url_for('static', filename='uploads/' ~ group.picture_filename) }}" class="card-img-top">
            {% endif %}
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ group.name }}</h5>
              <p class="card-text flex-grow-1">Members: {{ group.member_count }}</p>
              <button
                type="button"
                class="btn btn-primary basket-btn mt-auto"
                data-id="{{ group.id }}"
                data-name="{{ group.name }}"
                {% if group.id in basket_ids or group.id in purchased_ids %}disabled{% endif %}>
                {% if group.id in purchased_ids %}
                  Purchased
                {% elif group.id in basket_ids %}
                  Added to Cart
                {% else %}
                  Add to Cart
                {% endif %}
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Basket Sidebar -->
    <div class="col-md-4">
      <div class="card sticky-top" style="top:20px;">
        <div class="card-header">
          <h5 class="mb-0">
            Your Cart <span class="badge bg-secondary" id="basket-count">{{ basket_count }}</span>/{{ limit }}
          </h5>
          <small class="text-muted">{{ purchased_ids|length }} joined already</small>
        </div>
        <!-- Already Joined List -->
        {% if purchased_ids %}
        <div class="card-body">
          <h6>Groups Youâ€™ve Joined</h6>
          <ul class="list-group mb-3">
            {% for pid in purchased_ids %}
            {% set pg = groups|selectattr('id','equalto',pid)|first %}
            <li class="list-group-item">{{ pg.name }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        <ul class="list-group list-group-flush" id="basket-list" id="basket-list" style="max-height:70vh; overflow-y:auto;">
          {% for gid in basket_ids %}
          {% set g = groups|selectattr('id','equalto',gid)|first %}
          <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ gid }}">
            {{ g.name }}
            <button type="button" class="btn btn-sm btn-outline-danger remove-btn" data-id="{{ gid }}">Remove</button>
          </li>
          {% endfor %}
        </ul>
        <div class="card-body text-center">
          <a href="{{ url_for('main.checkout') }}" class="btn btn-success w-100" id="checkout-btn" {% if basket_count == 0 %}disabled{% endif %}>Checkout</a>
        </div>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const csrfToken = document.querySelector('#csrf-form input[name="csrf_token"]').value;

  function attachRemove(btn) {
    btn.addEventListener('click', () => {
      const gid = btn.dataset.id;
      fetch(`{{ url_for('main.remove_from_basket') }}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ group_id: gid })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.querySelector(`#basket-list li[data-id='${gid}']`).remove();
          const addBtn = document.querySelector(`.basket-btn[data-id='${gid}']`);
          if (addBtn) {
            addBtn.disabled = false;
            addBtn.textContent = 'Add to Cart';
          }
          document.getElementById('basket-count').textContent = data.basket_count;
        } else alert(data.message);
      });
    });
  }

  document.querySelectorAll('.remove-btn').forEach(btn => attachRemove(btn));

  document.querySelectorAll('.basket-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const gid = btn.dataset.id;
      fetch(`{{ url_for('main.add_to_basket') }}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ group_id: gid })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) return alert(data.message);
        btn.disabled = true;
        btn.textContent = 'Added to Cart';
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.dataset.id = gid;
        li.innerHTML = `${btn.dataset.name} <button class="btn btn-sm btn-outline-danger remove-btn" data-id="${gid}">Remove</button>`;
        document.getElementById('basket-list').appendChild(li);
        attachRemove(li.querySelector('.remove-btn'));
        document.getElementById('basket-count').textContent = data.basket_count;
      });
    });
  });
});
</script>
{% endblock %}
{% endblock %}